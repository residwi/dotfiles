#!/usr/bin/env bash
# Configure network stack: iwd + systemd-networkd + systemd-resolved

set -euo pipefail

DOTFILES_DIR="${DOTFILES_DIR:-$HOME/dotfiles}"

echo "Setting up network stack..."

# Enable iwd for WiFi
sudo systemctl enable --now iwd 2>/dev/null || true
echo "Enabled iwd"

# Disable networkd-wait-online to speed up boot
sudo systemctl disable --now systemd-networkd-wait-online.service 2>/dev/null || true
sudo systemctl mask systemd-networkd-wait-online.service 2>/dev/null || true
echo "Masked systemd-networkd-wait-online (faster boot)"

# Enable systemd-resolved
sudo systemctl enable --now systemd-resolved 2>/dev/null || true

# Symlink resolv.conf
sudo ln -sf /run/systemd/resolve/stub-resolv.conf /etc/resolv.conf
echo "Configured systemd-resolved"

# Install resolved config
if [[ -d "$DOTFILES_DIR/config/arch/systemd/resolved.conf.d" ]]; then
    sudo mkdir -p /etc/systemd/resolved.conf.d
    for conf in "$DOTFILES_DIR/config/arch/systemd/resolved.conf.d"/*; do
        [[ -f "$conf" ]] || continue
        sudo cp "$conf" "/etc/systemd/resolved.conf.d/$(basename "$conf")"
    done
    sudo systemctl restart systemd-resolved
    echo "Applied resolved config"
fi

# Enable Avahi for printer/mDNS discovery
sudo systemctl enable --now avahi-daemon 2>/dev/null || true
echo "Enabled Avahi daemon"

echo "Network setup complete!"
