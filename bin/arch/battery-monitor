#!/usr/bin/env bash
# Low battery warning - run via systemd timer

BATTERY_THRESHOLD=10
NOTIFICATION_FLAG="/run/user/$UID/battery_notified"
BATTERY_LEVEL=$(~/.local/bin/battery-remaining)
BATTERY_STATE=$(upower -i $(upower -e | grep 'BAT') | grep -E "state" | awk '{print $2}')

[[ -z "$BATTERY_LEVEL" || ! "$BATTERY_LEVEL" =~ ^[0-9]+$ ]] && exit 0

if [[ "$BATTERY_STATE" == "discharging" && "$BATTERY_LEVEL" -le "$BATTERY_THRESHOLD" ]]; then
  if [[ ! -f "$NOTIFICATION_FLAG" ]]; then
    notify-send -u critical "Û±êã Low Battery!" "Battery is at ${BATTERY_LEVEL}%" -t 30000
    touch "$NOTIFICATION_FLAG"
  fi
else
  rm -f "$NOTIFICATION_FLAG"
fi
