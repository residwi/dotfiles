#!/usr/bin/env bash
# Screenshot utility with smart selection

set -euo pipefail

[[ -f ~/.config/user-dirs.dirs ]] && source ~/.config/user-dirs.dirs
OUTPUT_DIR="${XDG_PICTURES_DIR:-$HOME/Pictures}/Screenshots"
mkdir -p "$OUTPUT_DIR"

pkill slurp 2>/dev/null && exit 0

MODE="${1:-smart}"

get_rectangles() {
  local active_workspace
  active_workspace=$(hyprctl monitors -j | jq -r '.[] | select(.focused == true) | .activeWorkspace.id')
  hyprctl monitors -j | jq -r --arg ws "$active_workspace" '.[] | select(.activeWorkspace.id == ($ws | tonumber)) | "\(.x),\(.y) \((.width / .scale) | floor)x\((.height / .scale) | floor)"'
  hyprctl clients -j | jq -r --arg ws "$active_workspace" '.[] | select(.workspace.id == ($ws | tonumber)) | "\(.at[0]),\(.at[1]) \(.size[0])x\(.size[1])"'
}

case "$MODE" in
  region)
    SELECTION=$(slurp 2>/dev/null) || exit 0
    ;;
  window)
    SELECTION=$(get_rectangles | slurp -r 2>/dev/null) || exit 0
    ;;
  fullscreen)
    SELECTION=$(hyprctl monitors -j | jq -r '.[] | select(.focused == true) | "\(.x),\(.y) \((.width / .scale) | floor)x\((.height / .scale) | floor)"')
    ;;
  smart|*)
    RECTS=$(get_rectangles)
    SELECTION=$(echo "$RECTS" | slurp 2>/dev/null) || exit 0

    if [[ "$SELECTION" =~ ^([0-9]+),([0-9]+)[[:space:]]([0-9]+)x([0-9]+)$ ]]; then
      if (( ${BASH_REMATCH[3]} * ${BASH_REMATCH[4]} < 20 )); then
        click_x="${BASH_REMATCH[1]}"
        click_y="${BASH_REMATCH[2]}"
        while IFS= read -r rect; do
          if [[ "$rect" =~ ^([0-9]+),([0-9]+)[[:space:]]([0-9]+)x([0-9]+) ]]; then
            rx="${BASH_REMATCH[1]}" ry="${BASH_REMATCH[2]}"
            rw="${BASH_REMATCH[3]}" rh="${BASH_REMATCH[4]}"
            if (( click_x >= rx && click_x < rx+rw && click_y >= ry && click_y < ry+rh )); then
              SELECTION="${rx},${ry} ${rw}x${rh}"
              break
            fi
          fi
        done <<< "$RECTS"
      fi
    fi
    ;;
esac

[[ -z "${SELECTION:-}" ]] && exit 0

grim -g "$SELECTION" - | \
  satty --filename - \
    --output-filename "$OUTPUT_DIR/screenshot-$(date +'%Y-%m-%d_%H-%M-%S').png" \
    --early-exit \
    --actions-on-enter save-to-clipboard \
    --save-after-copy \
    --copy-command 'wl-copy'
