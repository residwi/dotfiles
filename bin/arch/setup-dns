#!/usr/bin/env bash
# Configure DNS provider for systemd-resolved

set -euo pipefail

PROVIDER="${1:-dhcp}"

case "$PROVIDER" in
    dhcp)
        sudo rm -f /etc/systemd/resolved.conf.d/20-custom-dns.conf
        echo "DNS set to DHCP (router-provided)"
        ;;
    cloudflare)
        sudo tee /etc/systemd/resolved.conf.d/20-custom-dns.conf >/dev/null <<EOF
[Resolve]
DNS=1.1.1.1#cloudflare-dns.com 1.0.0.1#cloudflare-dns.com
FallbackDNS=9.9.9.9 149.112.112.112
DNSOverTLS=opportunistic
EOF
        echo "DNS set to Cloudflare (1.1.1.1) with DNS-over-TLS"
        ;;
    quad9)
        sudo tee /etc/systemd/resolved.conf.d/20-custom-dns.conf >/dev/null <<EOF
[Resolve]
DNS=9.9.9.9#dns.quad9.net 149.112.112.112#dns.quad9.net
FallbackDNS=1.1.1.1 1.0.0.1
DNSOverTLS=opportunistic
EOF
        echo "DNS set to Quad9 (9.9.9.9) with DNS-over-TLS"
        ;;
    *)
        echo "Usage: setup-dns [dhcp|cloudflare|quad9]"
        exit 1
        ;;
esac

sudo systemctl restart systemd-resolved
resolvectl status | head -20
