#!/usr/bin/env bash
# Screen recording with portal, audio options, and waybar indicator

set -euo pipefail

[[ -f ~/.config/user-dirs.dirs ]] && source ~/.config/user-dirs.dirs
OUTPUT_DIR="${XDG_VIDEOS_DIR:-$HOME/Videos}/Recordings"
mkdir -p "$OUTPUT_DIR"

DESKTOP_AUDIO=false
MIC_AUDIO=false

for arg in "$@"; do
  case "$arg" in
    --with-audio) DESKTOP_AUDIO=true ;;
    --with-mic) MIC_AUDIO=true ;;
    --stop)
      if pgrep -f "^gpu-screen-recorder" >/dev/null; then
        pkill -SIGINT -f "^gpu-screen-recorder"
        sleep 1
        pkill -RTMIN+8 waybar 2>/dev/null || true
        notify-send "Screen recording saved" "$OUTPUT_DIR"
      fi
      exit 0
      ;;
  esac
done

toggle_indicator() {
  pkill -RTMIN+8 waybar 2>/dev/null || true
}

if pgrep -f "^gpu-screen-recorder" >/dev/null; then
  pkill -SIGINT -f "^gpu-screen-recorder"
  for i in {1..50}; do
    pgrep -f "^gpu-screen-recorder" >/dev/null || break
    sleep 0.1
  done
  if pgrep -f "^gpu-screen-recorder" >/dev/null; then
    pkill -9 -f "^gpu-screen-recorder"
    notify-send "Recording stopped" "Force killed - video may be corrupted" -u critical
  else
    notify-send "Screen recording saved" "$OUTPUT_DIR"
  fi
  toggle_indicator
  exit 0
fi

AUDIO_ARGS=""
AUDIO_DEVICES=""

[[ "$DESKTOP_AUDIO" == true ]] && AUDIO_DEVICES+="default_output"
if [[ "$MIC_AUDIO" == true ]]; then
  [[ -n "$AUDIO_DEVICES" ]] && AUDIO_DEVICES+="|"
  AUDIO_DEVICES+="default_input"
fi
[[ -n "$AUDIO_DEVICES" ]] && AUDIO_ARGS="-a $AUDIO_DEVICES"

FILENAME="$OUTPUT_DIR/recording-$(date +'%Y-%m-%d_%H-%M-%S').mp4"
gpu-screen-recorder -w portal -f 60 -o "$FILENAME" $AUDIO_ARGS &

toggle_indicator
notify-send "Screen recording started" "Recording to $OUTPUT_DIR"
